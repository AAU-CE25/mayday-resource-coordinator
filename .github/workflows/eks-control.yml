name: EKS On/Off Control

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - stop
          - restart
          - delete
          - status
      image_tag:
        description: 'Image tag to deploy (only for deploy/restart)'
        required: false
        default: 'latest'
      scale_replicas:
        description: 'Number of replicas (only for deploy/restart)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'

env:
  AWS_REGION: eu-central-1
  EKS_CLUSTER_NAME: mayday-cluster
  NAMESPACE: mayday

jobs:
  control:
    name: EKS Control - ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "âœ… AWS Account ID: $ACCOUNT_ID"
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl version --client
          echo "âœ… kubectl configured"
      
      # ==================== DEPLOY ACTION ====================
      - name: Deploy Application
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "ðŸš€ Deploying application to EKS..."
          
          # Create namespace if not exists
          kubectl apply -f k8s/namespace.yaml
          
          # Apply ConfigMap
          kubectl apply -f k8s/configmap.yaml
          
          # Create/Update Secrets
          kubectl create secret generic mayday-secrets \
            --from-literal=POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
            --from-literal=POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            --from-literal=SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Update manifests with account ID and image tag
          ACCOUNT_ID="${{ steps.account.outputs.account_id }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          
          for file in k8s/*-deployment.yaml; do
            sed -i.bak "s|ACCOUNT_ID|$ACCOUNT_ID|g" $file
            sed -i.bak "s|:latest|:$IMAGE_TAG|g" $file
          done
          
          # Deploy PostgreSQL
          kubectl apply -f k8s/postgres-pvc.yaml
          kubectl apply -f k8s/postgres-deployment.yaml
          
          echo "â³ Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.NAMESPACE }} --timeout=300s || true
          
          # Deploy API Service
          kubectl apply -f k8s/api-deployment.yaml
          echo "â³ Waiting for API service..."
          kubectl wait --for=condition=ready pod -l app=api-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          
          # Get API URL
          sleep 30
          API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -z "$API_URL" ]; then
            API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          fi
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          
          # Update frontend and suv-ui with API URL
          sed -i.bak "s|http://API_SERVICE_URL|http://$API_URL|g" k8s/frontend-deployment.yaml
          sed -i.bak "s|http://API_SERVICE_URL|http://$API_URL|g" k8s/suv-ui-deployment.yaml
          
          # Deploy Frontend and SUV UI
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/suv-ui-deployment.yaml
          
          # Scale to requested replicas
          REPLICAS="${{ github.event.inputs.scale_replicas }}"
          kubectl scale deployment api-service --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          kubectl scale deployment frontend --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          kubectl scale deployment suv-ui --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          
          echo "âœ… Deployment completed!"
      
      # ==================== STOP ACTION ====================
      - name: Stop Application
        if: github.event.inputs.action == 'stop'
        run: |
          echo "ðŸ›‘ Stopping application (scaling to 0)..."
          
          # Scale all deployments to 0 (keeps database data)
          kubectl scale deployment api-service --replicas=0 -n ${{ env.NAMESPACE }} 2>/dev/null || echo "API service not found"
          kubectl scale deployment frontend --replicas=0 -n ${{ env.NAMESPACE }} 2>/dev/null || echo "Frontend not found"
          kubectl scale deployment suv-ui --replicas=0 -n ${{ env.NAMESPACE }} 2>/dev/null || echo "SUV UI not found"
          kubectl scale deployment postgres --replicas=0 -n ${{ env.NAMESPACE }} 2>/dev/null || echo "Postgres not found"
          
          echo "â³ Waiting for pods to terminate..."
          sleep 10
          
          echo "âœ… Application stopped (scaled to 0)"
          echo "ðŸ’¡ Database data is preserved in PVC"
          echo "ðŸ’¡ To fully delete everything, delete the namespace"
      
      # ==================== DELETE ACTION ====================
      - name: Delete Application
        if: github.event.inputs.action == 'delete'
        run: |
          echo "ðŸ—‘ï¸  COMPLETE DELETION: Removing EVERYTHING from AWS..."
          echo ""
          echo "âš ï¸  âš ï¸  âš ï¸  DANGER: This will delete EVERYTHING âš ï¸  âš ï¸  âš ï¸"
          echo ""
          echo "This will permanently delete:"
          echo "  - All deployments (API, Frontend, SUV UI, PostgreSQL)"
          echo "  - All services and LoadBalancers"
          echo "  - All ConfigMaps and Secrets"
          echo "  - âš ï¸  DATABASE DATA (PVC will be deleted!)"
          echo "  - âš ï¸  EKS CLUSTER (Control Plane)"
          echo "  - âš ï¸  ALL WORKER NODES"
          echo "  - âš ï¸  ALL NETWORK RESOURCES"
          echo ""
          echo "ðŸ’° After completion, cost will be: $0/month"
          echo ""
          
          # Step 1: Delete namespace and all resources
          if kubectl get namespace ${{ env.NAMESPACE }} &>/dev/null; then
            echo "ðŸ—‘ï¸  Step 1/3: Deleting namespace and all resources..."
            
            # Delete all deployments
            kubectl delete deployments --all -n ${{ env.NAMESPACE }} --timeout=60s || echo "No deployments found"
            
            # Delete all services (removes LoadBalancers)
            kubectl delete services --all -n ${{ env.NAMESPACE }} --timeout=60s || echo "No services found"
            
            # Delete all ConfigMaps
            kubectl delete configmaps --all -n ${{ env.NAMESPACE }} --timeout=30s || echo "No configmaps found"
            
            # Delete all Secrets
            kubectl delete secrets --all -n ${{ env.NAMESPACE }} --timeout=30s || echo "No secrets found"
            
            # Delete PVCs (this deletes database data!)
            kubectl delete pvc --all -n ${{ env.NAMESPACE }} --timeout=60s || echo "No PVCs found"
            
            echo "â³ Waiting for resources to be fully deleted..."
            sleep 30
            
            # Delete the entire namespace
            kubectl delete namespace ${{ env.NAMESPACE }} --timeout=120s || echo "Namespace already deleted"
            
            echo "âœ… Step 1/3 Complete: All application resources deleted"
          else
            echo "âœ… Step 1/3: Namespace doesn't exist - skipping"
          fi
          
          echo ""
          echo "ðŸ—‘ï¸  Step 2/3: Deleting EKS node groups..."
          
          # Get all node groups
          NODE_GROUPS=$(aws eks list-nodegroups --cluster-name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }} --query 'nodegroups' --output text 2>/dev/null || echo "")
          
          if [ -n "$NODE_GROUPS" ]; then
            for nodegroup in $NODE_GROUPS; do
              echo "  Deleting node group: $nodegroup"
              aws eks delete-nodegroup \
                --cluster-name ${{ env.EKS_CLUSTER_NAME }} \
                --nodegroup-name $nodegroup \
                --region ${{ env.AWS_REGION }} || echo "Failed to delete node group $nodegroup"
            done
            
            echo "â³ Waiting for node groups to be deleted (this takes 2-3 minutes)..."
            sleep 30
            
            # Wait for node groups to be fully deleted
            for nodegroup in $NODE_GROUPS; do
              echo "  Waiting for $nodegroup to be deleted..."
              aws eks wait nodegroup-deleted \
                --cluster-name ${{ env.EKS_CLUSTER_NAME }} \
                --nodegroup-name $nodegroup \
                --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Node group $nodegroup already deleted"
            done
            
            echo "âœ… Step 2/3 Complete: All node groups deleted"
          else
            echo "âœ… Step 2/3: No node groups found - skipping"
          fi
          
          echo ""
          echo "ðŸ—‘ï¸  Step 3/3: Deleting EKS cluster..."
          
          # Delete the EKS cluster
          if aws eks describe-cluster --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }} &>/dev/null; then
            echo "  Deleting cluster: ${{ env.EKS_CLUSTER_NAME }}"
            aws eks delete-cluster \
              --name ${{ env.EKS_CLUSTER_NAME }} \
              --region ${{ env.AWS_REGION }} || echo "Failed to delete cluster"
            
            echo "â³ Waiting for cluster to be deleted (this takes 5-10 minutes)..."
            echo "  You can close this window - deletion will continue in AWS"
            
            # Wait for cluster deletion (with timeout)
            aws eks wait cluster-deleted \
              --name ${{ env.EKS_CLUSTER_NAME }} \
              --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Cluster deletion initiated (may still be in progress)"
            
            echo "âœ… Step 3/3 Complete: EKS cluster deleted"
          else
            echo "âœ… Step 3/3: Cluster doesn't exist - skipping"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… âœ… âœ…  COMPLETE DELETION FINISHED  âœ… âœ… âœ…"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ’° Your AWS costs are now: $0/month"
          echo ""
          echo "Everything has been permanently deleted:"
          echo "  âœ… All application resources"
          echo "  âœ… All LoadBalancers (~$50/month saved)"
          echo "  âœ… All worker nodes (~$60/month saved)"
          echo "  âœ… EKS control plane (~$73/month saved)"
          echo "  âœ… All storage volumes (~$1/month saved)"
          echo "  âœ… Database data (permanently gone)"
      
      
      # ==================== RESTART ACTION ====================
      - name: Restart Application
        if: github.event.inputs.action == 'restart'
        run: |
          echo "ðŸ”„ Restarting application..."
          
          REPLICAS="${{ github.event.inputs.scale_replicas }}"
          
          # Scale PostgreSQL back up
          kubectl scale deployment postgres --replicas=1 -n ${{ env.NAMESPACE }}
          
          echo "â³ Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.NAMESPACE }} --timeout=300s || true
          
          # Scale other services
          kubectl scale deployment api-service --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          kubectl scale deployment frontend --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          kubectl scale deployment suv-ui --replicas=$REPLICAS -n ${{ env.NAMESPACE }}
          
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
          kubectl wait --for=condition=ready pod -l app=api-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=suv-ui -n ${{ env.NAMESPACE }} --timeout=300s || true
          
          echo "âœ… Application restarted!"
      
      # ==================== STATUS ACTION ====================
      - name: Check Status
        if: github.event.inputs.action == 'status'
        run: |
          echo "ðŸ“Š Checking application status..."
          echo ""
          
          if ! kubectl get namespace ${{ env.NAMESPACE }} &>/dev/null; then
            echo "âš ï¸ Namespace '${{ env.NAMESPACE }}' does not exist"
            echo "Run 'deploy' action first to create the application"
            exit 0
          fi
          
          echo "=== Deployments ==="
          kubectl get deployments -n ${{ env.NAMESPACE }} || echo "No deployments found"
          echo ""
          
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} || echo "No pods found"
          echo ""
          
          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }} || echo "No services found"
          echo ""
          
          echo "=== Persistent Volumes ==="
          kubectl get pvc -n ${{ env.NAMESPACE }} || echo "No PVCs found"
          echo ""
      
      # ==================== GET URLs (for all actions) ====================
      - name: Get Service URLs
        if: github.event.inputs.action != 'stop' && github.event.inputs.action != 'delete'
        id: urls
        run: |
          echo "ðŸŒ Retrieving service URLs..."
          
          # Wait a bit for LoadBalancers
          sleep 20
          
          # Get API URL
          API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -z "$API_URL" ]; then
            API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "not-available")
          fi
          
          # Get Frontend URL
          FRONTEND_URL=$(kubectl get svc frontend-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL=$(kubectl get svc frontend-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "not-available")
          fi
          
          # Get SUV UI URL
          SUV_URL=$(kubectl get svc suv-ui-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -z "$SUV_URL" ]; then
            SUV_URL=$(kubectl get svc suv-ui-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "not-available")
          fi
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "suv_url=$SUV_URL" >> $GITHUB_OUTPUT
          
          if [ "$API_URL" != "not-available" ]; then
            echo "âœ… API Service: http://$API_URL"
          else
            echo "â³ API Service: LoadBalancer provisioning..."
          fi
          
          if [ "$FRONTEND_URL" != "not-available" ]; then
            echo "âœ… Frontend: http://$FRONTEND_URL"
          else
            echo "â³ Frontend: LoadBalancer provisioning..."
          fi
          
          if [ "$SUV_URL" != "not-available" ]; then
            echo "âœ… SUV UI: http://$SUV_URL"
          else
            echo "â³ SUV UI: LoadBalancer provisioning..."
          fi
      
      # ==================== GENERATE SUMMARY ====================
      - name: Generate Summary
        run: |
          ACTION="${{ github.event.inputs.action }}"
          
          echo "## ðŸŽ›ï¸ EKS Control - ${ACTION^^}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`$ACTION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "$ACTION" = "deploy" ] || [ "$ACTION" = "restart" ]; then
            echo "**Image Tag:** \`${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Replicas:** ${{ github.event.inputs.scale_replicas }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$ACTION" = "stop" ]; then
            echo "### ðŸ›‘ Application Stopped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All services have been scaled to 0 replicas." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Database data is preserved** in the persistent volume" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **No pods are running** (cost savings)" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **LoadBalancers are removed** (cost savings)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To restart: Run this workflow with action 'restart'" >> $GITHUB_STEP_SUMMARY
            
          elif [ "$ACTION" = "delete" ]; then
            echo "### ðŸ—‘ï¸  COMPLETE DELETION SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# âš ï¸  EVERYTHING HAS BEEN PERMANENTLY DELETED âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ What Was Deleted:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| All deployments (API, Frontend, SUV UI, PostgreSQL) | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| All services and LoadBalancers | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| All ConfigMaps and Secrets | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Database data (PVC) | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Namespace (${{ env.NAMESPACE }}) | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| Worker nodes | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "| EKS Cluster (${{ env.EKS_CLUSTER_NAME }}) | âŒ Deleted |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’° Cost Impact:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Item | Before | After | Savings |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|-------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| EKS Control Plane | \$73/month | \$0 | **\$73** |" >> $GITHUB_STEP_SUMMARY
            echo "| Worker Nodes | \$60/month | \$0 | **\$60** |" >> $GITHUB_STEP_SUMMARY
            echo "| LoadBalancers | \$50/month | \$0 | **\$50** |" >> $GITHUB_STEP_SUMMARY
            echo "| Pod Compute | \$15/month | \$0 | **\$15** |" >> $GITHUB_STEP_SUMMARY
            echo "| Storage | \$1/month | \$0 | **\$1** |" >> $GITHUB_STEP_SUMMARY
            echo "| **TOTAL** | **\$194/month** | **\$0/month** | **\$194/month** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸŽ‰ You are now saving \$194 per month!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”„ To Deploy Again:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You will need to recreate the entire infrastructure:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Option 1: Using eksctl**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "eksctl create cluster \\" >> $GITHUB_STEP_SUMMARY
            echo "  --name ${{ env.EKS_CLUSTER_NAME }} \\" >> $GITHUB_STEP_SUMMARY
            echo "  --region ${{ env.AWS_REGION }} \\" >> $GITHUB_STEP_SUMMARY
            echo "  --nodegroup-name standard-workers \\" >> $GITHUB_STEP_SUMMARY
            echo "  --node-type t3.medium \\" >> $GITHUB_STEP_SUMMARY
            echo "  --nodes 2" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Option 2: Using AWS Console**" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to AWS EKS Console" >> $GITHUB_STEP_SUMMARY
            echo "2. Create new cluster: \`${{ env.EKS_CLUSTER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Add node group with 2x t3.medium instances" >> $GITHUB_STEP_SUMMARY
            echo "4. Then run this workflow with action: **deploy**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **Database will be empty** (fresh start)" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **New LoadBalancer URLs** will be generated" >> $GITHUB_STEP_SUMMARY
            
          elif [ "$ACTION" = "deploy" ] || [ "$ACTION" = "restart" ]; then
            echo "### ðŸŒ Service URLs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
            
            API_URL="${{ steps.urls.outputs.api_url }}"
            FRONTEND_URL="${{ steps.urls.outputs.frontend_url }}"
            SUV_URL="${{ steps.urls.outputs.suv_url }}"
            
            if [ "$API_URL" != "not-available" ] && [ -n "$API_URL" ]; then
              echo "| **API Service** | http://$API_URL | âœ… Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **API Service** | Provisioning... | â³ Pending |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$FRONTEND_URL" != "not-available" ] && [ -n "$FRONTEND_URL" ]; then
              echo "| **Frontend** | http://$FRONTEND_URL | âœ… Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Frontend** | Provisioning... | â³ Pending |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SUV_URL" != "not-available" ] && [ -n "$SUV_URL" ]; then
              echo "| **SUV UI** | http://$SUV_URL | âœ… Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **SUV UI** | Provisioning... | â³ Pending |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "| **PostgreSQL** | Internal (postgres-service:5432) | âœ… Available |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** LoadBalancer URLs may take 2-5 minutes to become fully active" >> $GITHUB_STEP_SUMMARY
            
          elif [ "$ACTION" = "status" ]; then
            echo "### ðŸ“Š Current Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            kubectl get all -n ${{ env.NAMESPACE }} 2>/dev/null || echo "Namespace not found or empty" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Configure kubectl" >> $GITHUB_STEP_SUMMARY
          echo "aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get all -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/api-service -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get service URLs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get svc -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$ACTION" = "deploy" ]; then
            echo "ðŸŽ‰ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          elif [ "$ACTION" = "stop" ]; then
            echo "âœ… **Application stopped - Cost savings active**" >> $GITHUB_STEP_SUMMARY
          elif [ "$ACTION" = "restart" ]; then
            echo "âœ… **Application restarted successfully!**" >> $GITHUB_STEP_SUMMARY
          elif [ "$ACTION" = "delete" ]; then
            echo "ðŸ—‘ï¸  **Deletion completed - All resources removed**" >> $GITHUB_STEP_SUMMARY
          elif [ "$ACTION" = "status" ]; then
            echo "ðŸ“Š **Status check completed**" >> $GITHUB_STEP_SUMMARY
          fi
