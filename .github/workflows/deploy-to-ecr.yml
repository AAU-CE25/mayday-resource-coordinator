name: Build and Push to AWS ECR

on:
  push:
    branches: [main, feature/MDAY-44-cloud-deployment]
    paths:
      - 'api_service/**'
      - 'domain/**'
      - 'frontend/**'
      - 'suv_ui/**'
      - '.github/workflows/deploy-to-ecr.yml'
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL for frontend builds (e.g., http://mayday-cluster-api-alb-123456.eu-central-1.elb.amazonaws.com)'
        required: false
        default: ''

env:
  AWS_REGION: eu-central-1
  CLUSTER_NAME: mayday-cluster

jobs:
  # Detect which services have changes
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      frontend: ${{ steps.changes.outputs.frontend }}
      suv_ui: ${{ steps.changes.outputs.suv_ui }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for changes
        id: changes
        run: |
          # For manual dispatch or release, build everything
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "release" ]; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "suv_ui=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          
          # Check api_service or domain changes
          if echo "$CHANGED_FILES" | grep -qE "^(api_service|domain)/"; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi
          
          # Check frontend changes
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          # Check suv_ui changes
          if echo "$CHANGED_FILES" | grep -q "^suv_ui/"; then
            echo "suv_ui=true" >> $GITHUB_OUTPUT
          else
            echo "suv_ui=false" >> $GITHUB_OUTPUT
          fi

  # API Service
  build-api:
    name: Build API Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Create ECR repository if it doesn't exist
        continue-on-error: true
        run: |
          aws ecr describe-repositories --repository-names api_service --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name api_service \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/api_service
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: api_service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Create ECR repository if it doesn't exist
        continue-on-error: true
        run: |
          aws ecr describe-repositories --repository-names frontend --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name frontend \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Set API URL
        id: api-url
        run: |
          # Priority: manual input > repository variable > fail
          if [ -n "${{ github.event.inputs.api_url }}" ]; then
            API_URL="${{ github.event.inputs.api_url }}"
          elif [ -n "${{ vars.ALB_DNS }}" ]; then
            API_URL="http://${{ vars.ALB_DNS }}"
          else
            echo "âŒ Error: No API URL provided!"
            echo "Either:"
            echo "  1. Set the ALB_DNS repository variable, or"
            echo "  2. Provide api_url when triggering manually"
            exit 1
          fi
          echo "url=${API_URL}" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ Using API URL: ${API_URL}"
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ steps.api-url.outputs.url }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # SUV UI
  build-suv-ui:
    name: Build SUV UI
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.suv_ui == 'true'
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Create ECR repository if it doesn't exist
        continue-on-error: true
        run: |
          aws ecr describe-repositories --repository-names suv_ui --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name suv_ui \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/suv_ui
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Set API URL
        id: api-url
        run: |
          # Priority: manual input > repository variable > fail
          if [ -n "${{ github.event.inputs.api_url }}" ]; then
            API_URL="${{ github.event.inputs.api_url }}"
          elif [ -n "${{ vars.ALB_DNS }}" ]; then
            API_URL="http://${{ vars.ALB_DNS }}"
          else
            echo "âŒ Error: No API URL provided!"
            echo "Either:"
            echo "  1. Set the ALB_DNS repository variable, or"
            echo "  2. Provide api_url when triggering manually"
            exit 1
          fi
          echo "url=${API_URL}" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ Using API URL: ${API_URL}"
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./suv_ui
          file: ./suv_ui/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ steps.api-url.outputs.url }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  summary:
    name: Build Summary
    needs: [build-api, build-frontend, build-suv-ui]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "## ðŸš€ ECR Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Built:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-api.result }}" == "success" ]; then
            echo "- âœ… api_service" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-api.result }}" == "skipped" ]; then
            echo "- â­ï¸ api_service (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ api_service (failed)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.build-frontend.result }}" == "success" ]; then
            echo "- âœ… frontend" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-frontend.result }}" == "skipped" ]; then
            echo "- â­ï¸ frontend (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ frontend (failed)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.build-suv-ui.result }}" == "success" ]; then
            echo "- âœ… suv_ui" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-suv-ui.result }}" == "skipped" ]; then
            echo "- â­ï¸ suv_ui (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ suv_ui (failed)" >> $GITHUB_STEP_SUMMARY
          fi

