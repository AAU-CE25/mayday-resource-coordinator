name: Build and Push to AWS ECR

on:
  push:
    branches: [main, feature/MDAY-44-cloud-deployment]
  release:
    types: [published, created]
  workflow_dispatch:  # Allows manual triggering

env:
  AWS_REGION: eu-central-1  # Change this to your AWS region
  
jobs:
  build-and-push:
    name: Build and Push Docker Images to ECR
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication
    
    strategy:
      matrix:
        service:
          - name: api_service
            context: .
            dockerfile: api_service/Dockerfile
          - name: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
          - name: suv_ui
            context: ./suv_ui
            dockerfile: ./suv_ui/Dockerfile
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Create ECR repository if it doesn't exist
        continue-on-error: true
        run: |
          aws ecr describe-repositories --repository-names ${{ matrix.service.name }} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name ${{ matrix.service.name }} \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256
      
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ matrix.service.name }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image digest
        run: |
          echo "Image pushed successfully!"
          echo "Repository: ${{ steps.login-ecr.outputs.registry }}/${{ matrix.service.name }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
      
      - name: Clean up old images (keep only latest)
        run: |
          echo "ðŸ§¹ Cleaning up old images..."
          
          # Get all image digests except the one tagged as 'latest'
          LATEST_DIGEST=$(aws ecr describe-images \
            --repository-name ${{ matrix.service.name }} \
            --image-ids imageTag=latest \
            --query 'imageDetails[0].imageDigest' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null) || true
          
          if [ -n "$LATEST_DIGEST" ] && [ "$LATEST_DIGEST" != "None" ]; then
            # Get all image digests that are NOT the latest
            OLD_DIGESTS=$(aws ecr describe-images \
              --repository-name ${{ matrix.service.name }} \
              --query "imageDetails[?imageDigest!='${LATEST_DIGEST}'].imageDigest" \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null) || true
            
            if [ -n "$OLD_DIGESTS" ] && [ "$OLD_DIGESTS" != "None" ]; then
              for digest in $OLD_DIGESTS; do
                echo "Deleting old image: $digest"
                aws ecr batch-delete-image \
                  --repository-name ${{ matrix.service.name }} \
                  --image-ids imageDigest=$digest \
                  --region ${{ env.AWS_REGION }} || true
              done
              echo "âœ… Old images deleted"
            else
              echo "âœ… No old images to delete"
            fi
          else
            echo "âš ï¸ Could not find latest image digest, skipping cleanup"
          fi
  
  summary:
    name: Deployment Summary
    needs: build-and-push
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "## ðŸš€ Release Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Name:** ${{ github.event.release.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All services have been built and pushed to AWS ECR!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… api_service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… frontend" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… suv_ui" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
