name: Deploy to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'

env:
  AWS_REGION: eu-central-1
  EKS_CLUSTER_NAME: mayday-cluster  # Change to your EKS cluster name
  NAMESPACE: mayday

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "âœ… AWS Account ID: $ACCOUNT_ID"
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
          kubectl version --client
          echo "âœ… kubectl configured for EKS cluster: ${{ env.EKS_CLUSTER_NAME }}"
      
      - name: Create namespace if not exists
        run: |
          kubectl apply -f k8s/namespace.yaml
          echo "âœ… Namespace created/verified"
      
      - name: Create/Update ConfigMap
        run: |
          kubectl apply -f k8s/configmap.yaml
          echo "âœ… ConfigMap applied"
      
      - name: Create/Update Secrets
        run: |
          # Create secrets from GitHub Secrets
          kubectl create secret generic mayday-secrets \
            --from-literal=POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
            --from-literal=POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            --from-literal=SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Secrets created/updated"
      
      - name: Update Kubernetes manifests with image tags
        run: |
          # Replace ACCOUNT_ID placeholder with actual account ID
          ACCOUNT_ID="${{ steps.account.outputs.account_id }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          
          # Update all deployment files
          for file in k8s/*-deployment.yaml; do
            sed -i "s|ACCOUNT_ID|$ACCOUNT_ID|g" $file
            sed -i "s|:latest|:$IMAGE_TAG|g" $file
          done
          
          echo "âœ… Updated manifests with Account ID: $ACCOUNT_ID and tag: $IMAGE_TAG"
      
      - name: Deploy PostgreSQL
        run: |
          kubectl apply -f k8s/postgres-pvc.yaml
          kubectl apply -f k8s/postgres-deployment.yaml
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… PostgreSQL deployed and ready"
      
      - name: Deploy API Service
        run: |
          kubectl apply -f k8s/api-deployment.yaml
          echo "â³ Waiting for API service to be ready..."
          kubectl wait --for=condition=ready pod -l app=api-service -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… API service deployed and ready"
      
      - name: Get API Service URL
        id: api-url
        run: |
          echo "â³ Waiting for LoadBalancer to get external IP..."
          sleep 30
          
          API_URL=""
          for i in {1..10}; do
            API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            if [ -n "$API_URL" ]; then
              break
            fi
            echo "Attempt $i/10: LoadBalancer not ready yet, waiting..."
            sleep 20
          done
          
          if [ -z "$API_URL" ]; then
            API_URL=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi
          
          if [ -n "$API_URL" ]; then
            echo "api_url=http://$API_URL" >> $GITHUB_OUTPUT
            echo "âœ… API Service URL: http://$API_URL"
          else
            echo "âš ï¸ LoadBalancer URL not available yet"
            echo "api_url=pending" >> $GITHUB_OUTPUT
          fi
      
      - name: Update Frontend and SUV UI with API URL
        run: |
          API_URL="${{ steps.api-url.outputs.api_url }}"
          
          # Update frontend deployment
          sed -i "s|http://API_SERVICE_URL|$API_URL|g" k8s/frontend-deployment.yaml
          # Update suv-ui deployment
          sed -i "s|http://API_SERVICE_URL|$API_URL|g" k8s/suv-ui-deployment.yaml
          
          echo "âœ… Updated frontend and SUV UI with API URL: $API_URL"
      
      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend-deployment.yaml
          echo "â³ Waiting for Frontend to be ready..."
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… Frontend deployed and ready"
      
      - name: Deploy SUV UI
        run: |
          kubectl apply -f k8s/suv-ui-deployment.yaml
          echo "â³ Waiting for SUV UI to be ready..."
          kubectl wait --for=condition=ready pod -l app=suv-ui -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… SUV UI deployed and ready"
      
      - name: Get Frontend URL
        id: frontend-url
        run: |
          echo "â³ Waiting for LoadBalancer to get external IP..."
          sleep 30
          
          FRONTEND_URL=""
          for i in {1..10}; do
            FRONTEND_URL=$(kubectl get svc frontend-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            if [ -n "$FRONTEND_URL" ]; then
              break
            fi
            echo "Attempt $i/10: LoadBalancer not ready yet, waiting..."
            sleep 20
          done
          
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL=$(kubectl get svc frontend-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi
          
          if [ -n "$FRONTEND_URL" ]; then
            echo "frontend_url=http://$FRONTEND_URL" >> $GITHUB_OUTPUT
            echo "âœ… Frontend URL: http://$FRONTEND_URL"
          else
            echo "âš ï¸ LoadBalancer URL not available yet"
            echo "frontend_url=pending" >> $GITHUB_OUTPUT
          fi
      
      - name: Get SUV UI URL
        id: suv-url
        run: |
          echo "â³ Waiting for LoadBalancer to get external IP..."
          sleep 30
          
          SUV_URL=""
          for i in {1..10}; do
            SUV_URL=$(kubectl get svc suv-ui-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            if [ -n "$SUV_URL" ]; then
              break
            fi
            echo "Attempt $i/10: LoadBalancer not ready yet, waiting..."
            sleep 20
          done
          
          if [ -z "$SUV_URL" ]; then
            SUV_URL=$(kubectl get svc suv-ui-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi
          
          if [ -n "$SUV_URL" ]; then
            echo "suv_url=http://$SUV_URL" >> $GITHUB_OUTPUT
            echo "âœ… SUV UI URL: http://$SUV_URL"
          else
            echo "âš ï¸ LoadBalancer URL not available yet"
            echo "suv_url=pending" >> $GITHUB_OUTPUT
          fi
      
      - name: Deployment Status
        run: |
          echo "ðŸ“Š Checking deployment status..."
          echo ""
          kubectl get all -n ${{ env.NAMESPACE }}
          echo ""
          echo "ðŸ“Š Checking pod logs..."
          kubectl get pods -n ${{ env.NAMESPACE }}
      
      - name: Configure CORS URLs
        run: |
          echo "ðŸ”§ Configuring CORS with LoadBalancer URLs..."
          echo ""
          
          # Get LoadBalancer URLs
          API_LB=$(kubectl get svc api-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || echo "")
          FRONTEND_LB=$(kubectl get svc frontend-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || echo "")
          SUV_LB=$(kubectl get svc suv-ui-service -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || echo "")
          
          if [ -n "$API_LB" ] && [ -n "$FRONTEND_LB" ] && [ -n "$SUV_LB" ]; then
            echo "âœ… All LoadBalancer URLs retrieved:"
            echo "   API: http://$API_LB"
            echo "   Frontend: http://$FRONTEND_LB"
            echo "   SUV UI: http://$SUV_LB"
            echo ""
            
            # Update ConfigMap with CORS URLs
            kubectl patch configmap mayday-config -n ${{ env.NAMESPACE }} --type merge -p "{
              \"data\": {
                \"FRONTEND_URL\": \"http://$FRONTEND_LB\",
                \"SUV_UI_URL\": \"http://$SUV_LB\",
                \"API_URL\": \"http://$API_LB\"
              }
            }"
            
            echo "âœ… ConfigMap updated with CORS URLs"
            echo ""
            echo "ðŸ”„ Restarting API deployment to apply CORS configuration..."
            
            # Restart API deployment to pick up new environment variables
            kubectl rollout restart deployment api-service -n ${{ env.NAMESPACE }}
            
            echo "â³ Waiting for API rollout to complete..."
            kubectl rollout status deployment api-service -n ${{ env.NAMESPACE }} --timeout=120s
            
            echo "âœ… CORS configuration complete!"
          else
            echo "âš ï¸ LoadBalancer URLs not fully available yet"
            echo "   You can manually configure CORS later using: ./k8s/update-cors-urls.sh"
          fi
      
      - name: Generate Deployment Summary
        run: |
          echo "## ðŸš€ EKS Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Service URLs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **API Service** | ${{ steps.api-url.outputs.api_url }} | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend** | ${{ steps.frontend-url.outputs.frontend_url }} | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| **SUV UI** | ${{ steps.suv-url.outputs.suv_url }} | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| **PostgreSQL** | Internal (postgres-service:5432) | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Quick Access Commands:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Configure kubectl" >> $GITHUB_STEP_SUMMARY
          echo "aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check deployment status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get all -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/api-service -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/frontend -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/suv-ui -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Scale deployments" >> $GITHUB_STEP_SUMMARY
          echo "kubectl scale deployment api-service --replicas=3 -n ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important Notes:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- LoadBalancer URLs may take 2-5 minutes to become fully active" >> $GITHUB_STEP_SUMMARY
          echo "- If URLs show as 'pending', check the AWS console or run:" >> $GITHUB_STEP_SUMMARY
          echo "  \`kubectl get svc -n ${{ env.NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Database is internal only (not exposed externally for security)" >> $GITHUB_STEP_SUMMARY
          echo "- To access the database, use port-forward:" >> $GITHUB_STEP_SUMMARY
          echo "  \`kubectl port-forward svc/postgres-service 5432:5432 -n ${{ env.NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
