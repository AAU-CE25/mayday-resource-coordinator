name: Terraform Infrastructure

on:
  push:
    branches:
      - main
      - feature/YOUR_BRANCH_NAME
      - feature/MDAY-44-cloud-deployment
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      cluster_name:
        description: 'ECS cluster name'
        required: false
        type: string
        default: 'mayday-cluster'

env:
  AWS_REGION: eu-central-1
  TF_VERSION: '1.6'
  WORKING_DIR: ./infra/terraform

jobs:
  terraform:
    name: Terraform ${{ github.event.inputs.action || 'plan' }}
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_KAJ }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_KAJ }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Select or Create Workspace
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'mayday-cluster' }}"
          
          # Only use workspace if not the default cluster
          if [ "$CLUSTER_NAME" != "mayday-cluster" ]; then
            echo "Using workspace: $CLUSTER_NAME"
            
            # List existing workspaces
            terraform workspace list
            
            # Select workspace or create if it doesn't exist
            terraform workspace select "$CLUSTER_NAME" || terraform workspace new "$CLUSTER_NAME"
            
            echo "Current workspace:"
            terraform workspace show
          else
            echo "Using default workspace for mayday-cluster"
            terraform workspace select default
          fi

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        if: github.event.inputs.action == 'plan'
        run: |
          terraform plan -no-color -input=false \
            -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID_KAJ }}" \
            -var="postgres_password=${{ secrets.POSTGRES_PASSWORD }}" \
            -var="cluster_name=${{ github.event.inputs.cluster_name || 'mayday-cluster' }}" \
            -out=tfplan
        continue-on-error: false

      - name: Upload Terraform Plan
        if: steps.plan.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

      - name: Terraform Apply
        id: apply
        if: github.event.inputs.action == 'apply'
        run: |
          terraform apply -auto-approve -input=false \
            -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID_KAJ }}" \
            -var="postgres_password=${{ secrets.POSTGRES_PASSWORD }}" \
            -var="cluster_name=${{ github.event.inputs.cluster_name || 'mayday-cluster' }}"

      - name: Check and Create Admin User
        if: github.event.inputs.action == 'apply' && steps.apply.outcome == 'success'
        run: |
          # Check if cluster already has admin user
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'mayday-cluster' }}"
          USERNAME="${CLUSTER_NAME}-admin"
          
          echo "Checking if admin user exists: $USERNAME"
          
          # Query DynamoDB for existing admin user with this username
          EXISTING_USER=$(aws dynamodb get-item \
            --table-name mayday-control-api-admin-users \
            --key '{"username":{"S":"'"$USERNAME"'"}}' \
            --region ${{ env.AWS_REGION }} \
            --output json | jq -r 'select(.Item != null) | .Item.username.S')
          
          if [ -z "$EXISTING_USER" ]; then
            echo "No admin user found. Creating default admin user..."
            
            # Generate password hash (SHA-256)
            PASSWORD_HASH=$(echo -n "admin123" | sha256sum | cut -d' ' -f1)
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Create admin user
            aws dynamodb put-item \
              --table-name mayday-control-api-admin-users \
              --item '{
                "username": {"S": "'"$USERNAME"'"},
                "password_hash": {"S": "'"$PASSWORD_HASH"'"},
                "cluster_name": {"S": "'"$CLUSTER_NAME"'"},
                "created_at": {"S": "'"$TIMESTAMP"'"}
              }' \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ Admin user created successfully"
            echo "Username: $USERNAME"
            echo "Password: admin123"
            echo "⚠️  IMPORTANT: Change this password after first login!"
          else
            echo "✅ Admin user already exists: $USERNAME"
          fi

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          echo "⚠️ WARNING: This will destroy all infrastructure!"
          terraform destroy -auto-approve -input=false \
            -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID_KAJ }}" \
            -var="postgres_password=${{ secrets.POSTGRES_PASSWORD }}" \
            -var="cluster_name=${{ github.event.inputs.cluster_name || 'mayday-cluster' }}"

      - name: Terraform Output
        if: github.event.inputs.action == 'apply' && steps.apply.outcome == 'success'
        run: |
          echo "=== Terraform Outputs ==="
          terraform output -json > outputs.json
          cat outputs.json
          
          echo ""
          echo "=== Access Information ==="
          echo "API URL: $(terraform output -raw api_url)"
          echo "ALB DNS: $(terraform output -raw alb_dns_name)"
          echo "ECS Cluster: $(terraform output -raw ecs_cluster_name)"

      - name: Upload Terraform Outputs
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: ${{ env.WORKING_DIR }}/outputs.json
          retention-days: 30